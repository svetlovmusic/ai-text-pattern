<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Повторение рисунка</title>
  <style>
	body {
	  margin: 0;
	  padding: 0;
	  overflow: hidden;
	  transition: background-color 0.3s, color 0.3s;
	  font-family: sans-serif;
	  font-size: 20px;
	  font-weight: 100;
	}

	#bgColorPicker {
	  position: absolute;
	  top: 10px;
	  left: 10px;
	  z-index: 10;
	}

	#themeInput {
	  position: absolute;
	  top: 10px;
	  left: 70px;
	  z-index: 10;
	  width: 200px;
	  font-size: 14px;
	  font-weight: 100;
	  border: 1px solid #ccc;
	  padding: 3px;
	  border-radius: 3px;
	  outline: none;
	}

	#generateButton {
	  position: absolute;
	  top: 10px;
	  left: 280px;
	  z-index: 10;
	  font-size: 14px;
	  font-weight: 100;
	  padding: 4px 8px;
	  border-radius: 3px;
	  border: 1px solid #ccc;
	  cursor: pointer;
	  background-color: #f6edda;
	}

	#pattern-container {
	  position: absolute;
	  top: 50%;
	  left: -100%;
	  width: 300%;
	  height: 300%;
	  transform: rotate(-30deg) translateY(-50%);
	  transform-origin: top left;
	  white-space: nowrap;
	  opacity: 0.8;
	  user-select: none;
	}

	.pattern-line {
	  line-height: 1.5em;
	}
  </style>
</head>
<body>
  <input type="color" id="bgColorPicker" value="#f6edda">
  <input type="text" id="themeInput" placeholder="Input theme...">
  <button id="generateButton">Gen</button>
  <div id="pattern-container"></div>

  <script>
	let words = [];
	
	fetch('words.json')
	  .then(res => res.json())
	  .then(data => {
		words = data;
		generatePatternLines(5000);
	  })
	  .catch(err => {
		console.error("Ошибка загрузки слов:", err);
	  });

	function shuffleArray(array) {
	  for (let i = array.length - 1; i > 0; i--) {
		const j = (Math.random() * (i + 1)) | 0;
		[array[i], array[j]] = [array[j], array[i]];
	  }
	}

	function getLuminance(hex) {
	  hex = hex.replace('#', '');
	  const r = parseInt(hex.substring(0, 2), 16) / 255;
	  const g = parseInt(hex.substring(2, 4), 16) / 255;
	  const b = parseInt(hex.substring(4, 6), 16) / 255;
	  return 0.299 * r + 0.587 * g + 0.114 * b;
	}

	function getTextColorForBackground(hex) {
	  return getLuminance(hex) > 0.5 ? "#666666" : "#eeeeee";
	}

	function generatePatternLines(lineCount) {
	  const container = document.getElementById('pattern-container');
	  container.textContent = '';
	  const fragment = document.createDocumentFragment();

	  for (let i = 0; i < lineCount; i++) {
		const tempWords = [...words];
		shuffleArray(tempWords);
		const lineDiv = document.createElement('div');
		lineDiv.className = 'pattern-line';
		lineDiv.textContent = tempWords.join(' ');
		fragment.appendChild(lineDiv);
	  }

	  container.appendChild(fragment);
	}

	generatePatternLines(500);

	const bgColorPicker = document.getElementById('bgColorPicker');
	bgColorPicker.addEventListener('input', (e) => {
	  const bgColor = e.target.value;
	  document.body.style.backgroundColor = bgColor;
	  document.body.style.color = getTextColorForBackground(bgColor);
	});

	const initialBg = bgColorPicker.value;
	document.body.style.backgroundColor = initialBg;
	document.body.style.color = getTextColorForBackground(initialBg);

	const generateButton = document.getElementById('generateButton');
	const themeInput = document.getElementById('themeInput');

	async function generateFromTheme() {
	  const theme = themeInput.value.trim();
	  if (!theme) return;

	  let OPENAI_API_KEY = localStorage.getItem('openai_token');
	  if (!OPENAI_API_KEY) {
		OPENAI_API_KEY = prompt('Введите API токен (sk-...)');
		if (OPENAI_API_KEY) {
		  localStorage.setItem('openai_token', OPENAI_API_KEY);
		} else {
		  return;
		}
	  }

	  try {
		const response = await fetch("https://api.openai.com/v1/chat/completions", {
		  method: "POST",
		  headers: {
			"Content-Type": "application/json",
			"Authorization": `Bearer ${OPENAI_API_KEY}`
		  },
		  body: JSON.stringify({
			model: "gpt-4o",
			response_format : {"type" : "json_object"},
			messages: [
			  {
				role: "system",
				content: "You are a helpful assistant that responds in JSON format."
			  },
			  {
				role: "user",
				content: `Generate a JSON array with 100 words related to the theme: ${theme}. Ensure the response is valid JSON, and do not include any additional text or formatting outside the array.`
			  }
			],
			temperature: 0.7
		  })
		});

		if (!response.ok) {
		  console.log("Ошибка при запросе:", response.status);
		  return;
		}

		const data = await response.json();
		console.log(data);
		const generatedContent = JSON.parse(data.choices[0].message.content); //choices[0].message.content
		words = generatedContent.words;
		generatePatternLines(5000);

	  } catch (error) {
		console.log("Ошибка:", error);
	  }
	}

	generateButton.addEventListener('click', generateFromTheme);
  </script>
</body>
</html>