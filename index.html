<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Повторение рисунка</title>
  <style>
	/* Основные стили */
	body {
	  margin: 0;
	  padding: 0;
	  overflow: hidden; /* Чтобы не появлялись полосы прокрутки */
	  transition: background-color 0.3s, color 0.3s;
	  font-family: sans-serif;
	  font-size: 20px;
	  font-weight: 100;
	}
	
	/* Инпут для выбора цвета фона */
	#bgColorPicker {
	  position: absolute;
	  top: 10px;
	  left: 10px;
	  z-index: 10;
	}

	/* Блок с повторяющимся текстом */
	#pattern-container {
	  position: absolute;
	  top: 50%;
	  left: -100%;
	  width: 300%;
	  height: 300%;
	  transform: rotate(-30deg) translateY(-50%);
	  transform-origin: top left;
	  white-space: nowrap; 
	  opacity: 0.8;
	  user-select: none;
	}

	/* Каждая "строка" слов */
	.pattern-line {
	  line-height: 1.5em;
	}
  </style>
</head>
<body>
	<!-- Модальное окно -->
	<div id="tokenModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
	  <div style="background:white; padding:20px; border-radius:8px; min-width:300px;">
		<h3>Введите API токен</h3>
		<input type="password" id="tokenInput" style="width:100%; margin-bottom:10px;" placeholder="sk-...">
		<button id="saveTokenButton">Сохранить</button>
	  </div>
	</div>
	
  <!-- Инпут для смены цвета фона -->
  <input type="color" id="bgColorPicker" value="#f6edda">

  <!-- Контейнер для фона из слов -->
  <div id="pattern-container"></div>

  <script>
	// Изначальный массив слов
	let words = [
	  "Гитара", "Компрессор", "Аудиоинтерфейс", "Эквалайзер", "Педаль", "Слайдер",
	  "Драм-машинка", "Микшер", "Сэмплер", "Микрофон", "Студийные", "Мониторы"
	];
  
	// Перемешивание массива
	function shuffleArray(array) {
	  for (let i = array.length - 1; i > 0; i--) {
		const j = (Math.random() * (i + 1)) | 0;
		[array[i], array[j]] = [array[j], array[i]];
	  }
	}
  
	// Контраст текста
	function getLuminance(hex) {
	  hex = hex.replace('#', '');
	  const r = parseInt(hex.substring(0, 2), 16) / 255;
	  const g = parseInt(hex.substring(2, 4), 16) / 255;
	  const b = parseInt(hex.substring(4, 6), 16) / 255;
	  return 0.299 * r + 0.587 * g + 0.114 * b;
	}
  
	function getTextColorForBackground(hex) {
	  return getLuminance(hex) > 0.5 ? "#666666" : "#eeeeee";
	}
  
	// Генерация строк
	function generatePatternLines(lineCount) {
	  const container = document.getElementById('pattern-container');
	  container.textContent = '';
	  const fragment = document.createDocumentFragment();
  
	  for (let i = 0; i < lineCount; i++) {
		const tempWords = [...words];
		shuffleArray(tempWords);
  
		const lineDiv = document.createElement('div');
		lineDiv.className = 'pattern-line';
		lineDiv.textContent = tempWords.join(' ');
		fragment.appendChild(lineDiv);
	  }
  
	  container.appendChild(fragment);
	}
  
	// Начальная генерация
	generatePatternLines(500);
  
	// Цвет фона
	const bgColorPicker = document.getElementById('bgColorPicker');
	bgColorPicker.addEventListener('input', (e) => {
	  const bgColor = e.target.value;
	  document.body.style.backgroundColor = bgColor;
	  document.body.style.color = getTextColorForBackground(bgColor);
	});
  
	const initialBg = bgColorPicker.value;
	document.body.style.backgroundColor = initialBg;
	document.body.style.color = getTextColorForBackground(initialBg);
  
	// Модалка
	function showTokenModal() {
	  document.getElementById('tokenModal').style.display = 'flex';
	}
  
	document.getElementById('saveTokenButton').addEventListener('click', () => {
	  const token = document.getElementById('tokenInput').value.trim();
	  if (token) {
		localStorage.setItem('openai_token', token);
		document.getElementById('tokenModal').style.display = 'none';
		generateFromTheme();
	  }
	});
  
	const generateButton = document.getElementById('generateButton');
	const themeInput = document.getElementById('themeInput');
  
	async function generateFromTheme() {
	  const theme = themeInput.value.trim();
	  if (!theme) return;
  
	  const OPENAI_API_KEY = localStorage.getItem('openai_token');
	  if (!OPENAI_API_KEY) {
		showTokenModal();
		return;
	  }
  
	  try {
		const response = await fetch("https://api.openai.com/v1/chat/completions", {
		  method: "POST",
		  headers: {
			"Content-Type": "application/json",
			"Authorization": `Bearer ${OPENAI_API_KEY}`
		  },
		  body: JSON.stringify({
			model: "gpt-4o",
			response_format : ["type" : "json_object"],
			messages: [
			  {
				role: "system",
				content: "You are a helpful assistant that responds in JSON format."
			  },
			  {
				role: "user",
				content: `Generate a JSON array with 100 words related to the theme: ${theme}. Ensure the response is valid JSON, and do not include any additional text or formatting outside the array.`
			  }
			],
			temperature: 0.7
		  })
		});
  
		if (!response.ok) {
		  console.log("Ошибка при запросе:", response.status);
		  return;
		}
  
		const data = await response.json();
		const generatedWords = JSON.parse(data.choices[0].message.content);
  
		words = generatedWords;
		generatePatternLines(500);
  
	  } catch (error) {
		console.log("Ошибка:", error);
	  }
	}
  
	generateButton.addEventListener('click', generateFromTheme);
  </script>
</body>
</html>